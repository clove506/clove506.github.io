	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>【合肥】系统公共服务二期-高频对象工厂/RPC调用易用性升级/并发&amp;资源锁 | Hexo</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="摘要二期的详细内容。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="【合肥】系统公共服务二期-高频对象工厂/RPC调用易用性升级/并发&amp;资源锁"/>
  <meta property="og:site_name" content="Hexo"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
                <li>
                    <a href="/atom.xml" title="这是一个订阅源">
                    <i class="fa fa-rss"></i>RSS
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9 center-content">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>【合肥】系统公共服务二期-高频对象工厂/RPC调用易用性升级/并发&amp;资源锁</h2>
					
					<div>
						<span class="post-time">2016-12-14 17:00:00</span>
					</div>	
					

					<div class="article-content">
						<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>二期的详细内容。</p>
<a id="more"></a>
<h2 id="WIKI维护人"><a href="#WIKI维护人" class="headerlink" title="WIKI维护人"></a>WIKI维护人</h2><p>陈晨</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="高频对象工厂"><a href="#高频对象工厂" class="headerlink" title="高频对象工厂"></a>高频对象工厂</h3><p>系统公共服务一期上线了快速获取Nurse信息的注解，通过加注解，可以在Localthread中设置相应的线程独享上下文，在通过统一的工厂获取，使用简单，方便，屏蔽了各种底层获取逻辑，异常处理等。二期打算对该部分逻辑进行升级，覆盖到患者信息，订单信息。</p>
<h3 id="RPC调用易用性升级"><a href="#RPC调用易用性升级" class="headerlink" title="RPC调用易用性升级"></a>RPC调用易用性升级</h3><p>我们的RPC调用结合了很多内容，在使用上已经相对方便，只需要引入Halo包，调用相关应用的Inteface方法即可。但是这里忽略了统一的异常处理，调用日志，断路处理等，各个应用方需要写很多冗余的样板代码。本期需要对新提供的RPC调用提供上述统一的处理，旧接口，兼容升级。</p>
<h3 id="并发-amp-资源锁"><a href="#并发-amp-资源锁" class="headerlink" title="并发&amp;资源锁"></a>并发&amp;资源锁</h3><p>提供对并发和某些资源的锁机制，保护系统安全。</p>
<h2 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h2><h3 id="高频对象工厂-提供订单、患者、服务商品、护士信息的快捷访问"><a href="#高频对象工厂-提供订单、患者、服务商品、护士信息的快捷访问" class="headerlink" title="高频对象工厂-提供订单、患者、服务商品、护士信息的快捷访问"></a>高频对象工厂-提供订单、患者、服务商品、护士信息的快捷访问</h3><p><strong>注意：本次升级不向前兼容</strong></p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>通过在方法上加入Halo指定的注解，通过AOP方式从Http的Header中获取必要参数，将构建好的HaloContext中放入Localthread，最终通过统一的接口对外提供Context。</p>
<p><strong>注解</strong></p>
<ul>
<li>@CNurse</li>
<li>@CPatient</li>
<li>@Admin</li>
<li>@COrder</li>
<li>@CItem</li>
</ul>
<p>其中的C是Context的缩写，避免和其他JAR提供的注解冲突。</p>
<p><strong>HaloContextFactory中的获取方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> HaloContext <span class="title">getUserContextFromRequest</span><span class="params">()</span></span></div></pre></td></tr></table></figure>
<p><strong>HaloContextFactory中的构造方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> HaloContext <span class="title">buildContextFrom</span><span class="params">(HaloEnum haloEnum, Annotation contextAnnotation)</span></span></div></pre></td></tr></table></figure>
<p>构造方法中会在AOP中统一通过切点进入。</p>
<p>其中的HaloEnum和注解一一对应（方便使用，其实可以通过反射加规约实现）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> HaloEnum &#123;</div><div class="line">    Nurse,</div><div class="line">    Patient,</div><div class="line">    Admin,</div><div class="line">    Order,</div><div class="line">    Item</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>contextAnnotation 即是上面创建的注解</p>
<p><strong>HaloContext的内容</strong></p>
<p>HaloContext的内容就是对应注解的标注的内容，如Nurse，会有Nurse的基本信息，Tag信息等。</p>
<p><strong>HaloContextFactory</strong></p>
<p>构建过程就是调用各个底层service拼接Context中定义内容的过程。</p>
<p><strong>性能问题解决方法1</strong></p>
<p>例如Order中会有Order信息，Action信息，护士信息，患者信息，如果一口气全获取会造造成很多无误的IO，这里讲获取的权利交给使用放，通过在注解中添加各类参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CNurse &#123;</div><div class="line">    <span class="comment">//you can use string below for convenience</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">needTag</span><span class="params">()</span>  <span class="keyword">default</span> <span class="keyword">false</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>性能问题解决方法2</strong></p>
<p>一个应用中不同的方法可能都用到了同一个注解，如果每次都获取一遍，性能会非常差，这里做了一个优化，如果当前线程中已经保存了注解对应的内容，则直接返回不保存。</p>
<h4 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h4><p>完善Item Order的内容，这里要根据学文产出的OrderAPI来定制，放到后续工作中。</p>
<h3 id="RPC调用易用性升级-1"><a href="#RPC调用易用性升级-1" class="headerlink" title="RPC调用易用性升级"></a>RPC调用易用性升级</h3><p>把旧的PRC调用和新的调用改造成如下内容，需要注意以下几个方面：</p>
<ul>
<li>异常方法的处理</li>
<li>各种日志</li>
<li>完善断路器</li>
<li>对异常情况抛统一的YHJException</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> Yolar.<span class="function">NurseDTO <span class="title">getNurseByToken</span><span class="params">(String token)</span> </span>&#123;</div><div class="line"></div><div class="line">        String where = <span class="string">"UserServiceWrap-&gt;getNurseByToken"</span>;</div><div class="line"></div><div class="line">        Yolar.NurseDTO ret;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ret = yolarClient.getNurseByToken(token);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.error(YHJExceptionCode.THIRD_SERVICE_EXCEPTION.getMessage4Log(), e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> YHJException(YHJExceptionCode.THIRD_SERVICE_EXCEPTION, where + <span class="string">"unknown exception"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!ret.hasResult()) &#123;</div><div class="line">            String logMessage = LogInfoGenerator.generateErrorInfo(where,YHJExceptionCode.THIRD_SERVICE_EXCEPTION,<span class="string">"api result empty"</span>,<span class="string">"token"</span>,token);</div><div class="line">            logger.error(logMessage);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> YHJException(YHJExceptionCode.THIRD_SERVICE_EXCEPTION, logMessage);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!ret.getResult().getSuccess()) &#123;</div><div class="line">            String logMessage = LogInfoGenerator.generateErrorInfo(where,YHJExceptionCode.THIRD_SERVICE_EXCEPTION,<span class="string">"api result not success"</span>,<span class="string">"token"</span>,token,<span class="string">"result"</span>,ret);</div><div class="line">            logger.error(logMessage);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> YHJException(YHJExceptionCode.THIRD_SERVICE_EXCEPTION, logMessage);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//不是出错信息</span></div><div class="line">        <span class="keyword">if</span> (!ret.hasId()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="并发-amp-资源锁-1"><a href="#并发-amp-资源锁-1" class="headerlink" title="并发&amp;资源锁"></a>并发&amp;资源锁</h3><p>新建请求如果并发的话会造成同样内容的脏数据，为了避免这种情况需要加并发锁，该锁在特定时间内会失效。失效后并不会对原有业务或者系统造成影响。</p>
<p>并发锁并不能保证资源同一时间只能只有一方来操作，如果多方的动作是互斥的，则会造成不可预期的影响，这种情况下需要对资源加锁。 这种类型的锁需要根据业务的特点来判断锁是否超时失效，针对这种情况，提供了两种锁的思路，一种是超时自动释放的锁，一种是不会失效的锁。</p>
<p>不会失效的锁在异常情况下需要业务方根据业务特点自动解决异常，如通过检查，发现锁可以被去除，则业务方需要自主调用去锁方法。</p>
<p>相关详情查看: <a href="http://wiki.office.test.youhujia.com/2016/12/13/Hefei_C_Lock/" target="_blank" rel="external">锁</a></p>
<h2 id="时间点"><a href="#时间点" class="headerlink" title="时间点"></a>时间点</h2><table>
<thead>
<tr>
<th>工作内容</th>
<th>内容详情</th>
<th>人日</th>
</tr>
</thead>
<tbody>
<tr>
<td>高频对象工厂</td>
<td>1. 确认Item Order 内容详情，制定API <br> 2.  代码编写 <br> 3. 测试</td>
<td>3人日</td>
</tr>
<tr>
<td>RPC调用易用性升级</td>
<td>1. 优先保证新接口的内容，有各自项目Owner自己评估时间，整合到HALO中。<br> 2. 旧接口改造升级（这次业务代码中用到的接口来改造，比如用户相关内容）。</td>
<td>2人日</td>
</tr>
<tr>
<td>并发&amp;资源锁</td>
<td>详细内容参考 <a href="http://wiki.office.test.youhujia.com/2016/12/13/Hefei_C_Lock/" target="_blank" rel="external">锁</a></td>
<td>大致5-6人日，已经单独启动 </td>
</tr>
</tbody>
</table>
<p>总体需要投入5人日开发。</p>

					</div>

			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  

		<div class="comment-section">
  
  


</div>
	</div>

	

</div>


		<footer>
			

<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2017 <a href="http://yoursite.com"> John Doe </a>
</p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
