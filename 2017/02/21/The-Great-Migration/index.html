	<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>优护家公众号迁移 详细设计 | Hexo</title>
  <meta name="author" content="John Doe">
  
  <meta name="description" content="摘要优护家公众号迁移 详细设计">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="优护家公众号迁移 详细设计"/>
  <meta property="og:site_name" content="Hexo"/>

  
  
		<!-- favicon -->
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
		<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
		<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.png">
		<meta name="theme-color" content="#009688">
		<!-- favicon end -->
    <!-- <link href="/favicon.ico" rel="icon"> -->
  

  <!-- toc -->
  <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css">

  <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">

  <!-- material design -->
	<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
  <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css">
  <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
	<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

  

  

  <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="/libs/jquery-2.0.3.min.js" type="text/javascript"><\/script>')</script>

</head>

 	<body>
	  <nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">菜单</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Hexo</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    <a href="/" title="">
                    <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                <li>
                    <a href="/archives" title="">
                    <i class="fa fa-list"></i>存档
                    </a>
                </li>
                
                <li>
                    <a href="/about" title="">
                    <i class="fa fa-info-circle"></i>关于
                    </a>
                </li>
                
                <li>
                    <a href="/atom.xml" title="这是一个订阅源">
                    <i class="fa fa-rss"></i>RSS
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>

	  <div class="container" >
	    <div class="row">
	
	<div class="col-md-9 center-content">
	

		<div class="content">
			<!-- index -->
		   

			  		<h2>优护家公众号迁移 详细设计</h2>
					
					<div>
						<span class="post-time">2017-02-21 15:30:00</span>
					</div>	
					

					<div class="article-content">
						<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>优护家公众号迁移 详细设计</p>
<a id="more"></a>
<h1 id="优护家公众号迁移-详细设计"><a href="#优护家公众号迁移-详细设计" class="headerlink" title="优护家公众号迁移 详细设计"></a>优护家公众号迁移 详细设计</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>之前的 优护创智 公众号因为经营范围不妥，需要更换到新公众号：优护家。</p>
<h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><p>优护家公众号迁移后，老用户的数据不受影响。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li>用户在新公众号授权登陆后，在返回的接口里新添字端，告知前端还需 redirect 到微信授权页面，获取该用户在旧公众号下的 OldOpenID</li>
<li>查看 OldOpenID 是否对应已有用户</li>
<li>如果无，按正常流程执行</li>
<li>如果存在旧用户，将该用户迁移到对应旧用户下，并更新 OpenID</li>
<li>对该用户标记 Flag，下次登录时，无需上述额外 redirect</li>
</ol>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p><strong>POST /api/era/v1/users/signin/XXXXXNew-Open-IDXXXXXXX</strong></p>
<p>其中去往微信的url中携带的callbackUrl为固定的前端地址，确定为：/ns/take-deprecated-wx-account-token</p>
<ul>
<li><p>Response</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"result"</span> : &#123;<span class="attr">"success"</span> : <span class="literal">true</span>,</div><div class="line">              <span class="attr">"code"</span>:<span class="number">0</span></div><div class="line">              &#125;,</div><div class="line">  <span class="attr">"token"</span> : <span class="string">"auth-token-xxxxxxx"</span>,</div><div class="line">  <span class="attr">"redirect"</span> : <span class="string">"https://open.weixin.qq.com/connect/oauth2/authorize?xxxxxx"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="尝试迁移旧用户"><a href="#尝试迁移旧用户" class="headerlink" title="尝试迁移旧用户"></a>尝试迁移旧用户</h3><p><strong>POST /api/era/v1/users/migrate-old-wx/XXXXXOld-Open-IDXXXXXXX</strong></p>
<ul>
<li><p>Response</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"result"</span> : &#123;<span class="attr">"success"</span> : <span class="literal">true</span>,</div><div class="line">              <span class="attr">"code"</span>:<span class="number">0</span>&#125;,</div><div class="line">  <span class="attr">"token"</span> : <span class="string">"auth-token-xxxMay-Changexxxx"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="数据库修改"><a href="#数据库修改" class="headerlink" title="数据库修改"></a>数据库修改</h2><p>在 Person 表中添加一个 flag 字端，该字段以 json 的方式存储该 Person 是否已做过迁移处理(之后也可用来存储其他类似信息)，以避免重复操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">'db migartion</div><div class="line"></div><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> person <span class="keyword">add</span> flag <span class="built_in">varchar</span>(<span class="number">2014</span>)</div></pre></td></tr></table></figure>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>登录时检查用户是否已经做过迁移处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Person p = getPersonByOpenID(openId);</div><div class="line"></div><div class="line"><span class="keyword">boolean</span> hasMigrated = checkIfHasMigrated(p.flag);</div><div class="line"></div><div class="line"><span class="keyword">if</span>(!hasMigrated)&#123;</div><div class="line">  <span class="keyword">return</span> resp with redirect to old wx-account to get oldOpenId</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>获取旧 OpenID 后，做旧数据迁移</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">String OldOpenId;</div><div class="line">String newOpenId;</div><div class="line"></div><div class="line">WxProfile oldProfile = findWxProfileByOpenId(oldOpenId);</div><div class="line"><span class="keyword">if</span>(exist(oldProfile))&#123;</div><div class="line">  deleteWxProfileByOpenId(newOpenId);</div><div class="line">  </div><div class="line">  oldProfile.setOpenID(newOpenId);</div><div class="line">  save(oldProfile);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> oldProfile.person.authToken;</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">  <span class="keyword">return</span> findWxProfileByOpenId(newOpenId).person.authToken</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="备忘"><a href="#备忘" class="headerlink" title="备忘"></a>备忘</h2><p>需要修改配置的相关项目：</p>
<ol>
<li>支付</li>
<li>微信模版消息</li>
<li>之前根据生成的公众号二维码，需删除后重新生成</li>
<li>…more</li>
</ol>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>用户登录时序图<img src="/media/mig_login.png" alt="mig_login"></p>
<p>数据迁移流程图<img src="/media/mig.png" alt="mig"></p>
<h2 id="排期"><a href="#排期" class="headerlink" title="排期"></a>排期</h2><table>
<thead>
<tr>
<th>Date</th>
<th>Content</th>
<th>Man-Day</th>
</tr>
</thead>
<tbody>
<tr>
<td>2017-02-21</td>
<td>设计</td>
<td>1</td>
</tr>
<tr>
<td>2017-02-22</td>
<td>开发</td>
<td>1.5</td>
</tr>
<tr>
<td>2017-03-01</td>
<td>自测</td>
<td>1</td>
</tr>
<tr>
<td>2017-03-02</td>
<td>提测</td>
<td>0.5</td>
</tr>
<tr>
<td>2017-03-03</td>
<td>部署</td>
<td>1</td>
</tr>
</tbody>
</table>
<h2 id="项目日报"><a href="#项目日报" class="headerlink" title="项目日报"></a>项目日报</h2><p>2017-03-03：<br>本日完成：完成优护家公众号迁移自测。<br>明日计划：统计更换公众号APPId对其他项目的影响，同时与正宇和UI同学确认访问老公众号引导用户到新公众号的形式（图片二维码或者是其他）。</p>
<p>2017-03-04：<br>本日完成：更换公众号影响CMS,era,gateway,kfb,singer,midas项目，已与相关人员沟通，确认迁移风险。迁移dev环境回归测试完成，老用户信息以及支付功能不受影响。老公众号引导到新公众号方案确定为二维码+图片（有强运营需求再配文字）。<br>明日计划：修改线上环境配置，部署。</p>
<p>2017-03-06：<br>本日完成：因为预发环境测试冲突，今天staging环境部署未完成，继续在dev环境测试，同时出迁移上线流程<br>明日计划：为了使用户进入迁移逻辑，需要reset 所有的token（包括护士），明天重点测试；修改线上环境配置，部署。</p>
<p>2017-03-07：<br>身体gg，请假</p>
<p>2017-03-08：<br>本日完成：token reset风险排除；dev环境测试结束，项目部署staging环境进行测试<br>明日计划：修改线上环境配置，部署。</p>
<p>2017-03-08：<br>本日完成：修改线上环境配置，部署，正式上线。</p>
<h2 id="优护家公众号数据迁移上线流程："><a href="#优护家公众号数据迁移上线流程：" class="headerlink" title="优护家公众号数据迁移上线流程："></a>优护家公众号数据迁移上线流程：</h2><ol>
<li>修改era,yolar,gateway中相关配置文件以,还原develop、release开发环境</li>
<li>era,yolar,halo,gateway项目release分支代码并进master分支</li>
<li>修改config_repo 中master分支中era,cms,kfb,gateway,singer,difoil,dna,yolar,prod环境和docker_prod环境的配置</li>
<li>重启服务，部署上线</li>
</ol>

					</div>

			  <!-- about -->
			  
		</div>

		<!-- pagination -->
	  

		<div class="comment-section">
  
  


</div>
	</div>

	

</div>


		<footer>
			

<p>
  由 <a href="https://hexo.io">hexo</a> 强力驱动 | 搭载 <a href="https://github.com/wayou/hexo-theme-material">material</a> 主题
</p>
<p>
  &copy; 2017 <a href="http://yoursite.com"> John Doe </a>
</p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	  </div>

		<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>

		<!-- material design -->
		<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script>
		<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>
		<!-- toc -->
		<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
		<script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
		<script src="/libs/tocify/jquery.tocify.custom.js"></script>

		<script src="/js/main.js"></script>

	</body>
</html>
